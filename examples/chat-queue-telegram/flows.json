[
    {
        "id": "b19d2de2.d6a79",
        "type": "tab",
        "label": "Scheduler API",
        "disabled": false,
        "info": ""
    },
    {
        "id": "d6af186b.004918",
        "type": "tab",
        "label": "Chat WS <> Telegram",
        "disabled": false,
        "info": ""
    },
    {
        "id": "5ed67383.5985ac",
        "type": "redis-config",
        "z": "",
        "name": "redis:6379",
        "options": "{\"host\":\"redis\"}",
        "cluster": false,
        "optionsType": "json"
    },
    {
        "id": "28c31e1f.031b7a",
        "type": "telegram bot",
        "z": "",
        "botname": "Ghost",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "3000",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "",
        "localbotport": "8443",
        "publicbotport": "8443",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "verboselogging": true
    },
    {
        "id": "ad6fda06.930828",
        "type": "websocket-listener",
        "z": "",
        "path": "/agent/receive",
        "wholemsg": "false"
    },
    {
        "id": "f3eba521.b2e75",
        "type": "websocket-listener",
        "z": "",
        "path": "/agent/publish",
        "wholemsg": "false"
    },
    {
        "id": "27bd0690.bbba72",
        "type": "function",
        "z": "d6af186b.004918",
        "name": "format message",
        "func": "return [ \n    {\n        payload: {\n            \"chatId\":  global.get('telegramID'),\n            \"type\": \"message\",\n            \"options\": { \"parse_mode\": \"Markdown\" },\n            \"content\": \"Agent: How may I help you?\"\n        }\n    },\n    {\n        payload: {\n            msg:\"Signal: Connecting user: \" +  global.get('telegramID') + \" for ixn=\" + msg.payload.id,\n            timestamp: new Date().getTime()\n        }\n    }\n]",
        "outputs": 2,
        "noerr": 0,
        "x": 780,
        "y": 760,
        "wires": [
            [
                "97f98ca8.68217"
            ],
            [
                "686f3fcb.5bb7"
            ]
        ]
    },
    {
        "id": "83273acf.ef29",
        "type": "catch",
        "z": "b19d2de2.d6a79",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 140,
        "y": 820,
        "wires": [
            [
                "f174a574.3cfdd"
            ]
        ]
    },
    {
        "id": "f174a574.3cfdd",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 990,
        "y": 820,
        "wires": []
    },
    {
        "id": "9a2b4e5.a67fbb",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "TimeIndex",
        "func": "msg.payload = [ msg.triggerTimeMs, msg.uuid ]\nmsg.topic = \"tasks\"\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 100,
        "wires": [
            [
                "881d73b7.68475"
            ]
        ]
    },
    {
        "id": "50bad933.6b4ce",
        "type": "http in",
        "z": "b19d2de2.d6a79",
        "name": "",
        "url": "/tasks",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "6f639e3e.b4ca7"
            ]
        ]
    },
    {
        "id": "b4cd0c04.d7381",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1390,
        "y": 180,
        "wires": []
    },
    {
        "id": "3fcd1591.b8b802",
        "type": "http response",
        "z": "b19d2de2.d6a79",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 990,
        "y": 300,
        "wires": []
    },
    {
        "id": "881d73b7.68475",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "zadd",
        "name": "",
        "topic": "",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 1060,
        "y": 140,
        "wires": [
            [
                "49fd0459.99431c"
            ]
        ]
    },
    {
        "id": "6f639e3e.b4ca7",
        "type": "uuid",
        "z": "b19d2de2.d6a79",
        "uuidVersion": "v4",
        "namespaceType": "",
        "namespace": "",
        "namespaceCustom": "",
        "name": "",
        "field": "uuid",
        "fieldType": "msg",
        "x": 210,
        "y": 140,
        "wires": [
            [
                "f9dba8e5.51d4e"
            ]
        ]
    },
    {
        "id": "fead6e8.245de1",
        "type": "comment",
        "z": "b19d2de2.d6a79",
        "name": "Task create",
        "info": "",
        "x": 80,
        "y": 60,
        "wires": []
    },
    {
        "id": "475c54c5.c6ef64",
        "type": "moment",
        "z": "b19d2de2.d6a79",
        "name": "ISO => EPOCH",
        "topic": "",
        "input": "payload.triggerTimeISO",
        "inputType": "msg",
        "inTz": "ETC/GMT",
        "adjAmount": 0,
        "adjType": "days",
        "adjDir": "add",
        "format": "date",
        "locale": "POSIX",
        "output": "triggerTimeDate",
        "outputType": "msg",
        "outTz": "Europe/Paris",
        "x": 480,
        "y": 140,
        "wires": [
            [
                "4bacfc32.e71ae4"
            ]
        ]
    },
    {
        "id": "b8f3b370.5a855",
        "type": "http in",
        "z": "b19d2de2.d6a79",
        "name": "",
        "url": "/tasks",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 300,
        "wires": [
            [
                "b29d1f4a.207ce8"
            ]
        ]
    },
    {
        "id": "205132b8.03fd46",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "zrangebyscore",
        "name": "",
        "topic": "tasks",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 570,
        "y": 300,
        "wires": [
            [
                "47af8106.938be"
            ]
        ]
    },
    {
        "id": "b29d1f4a.207ce8",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Pre-Process",
        "func": "msg.payload = [ \"-inf\", \"+inf\" ]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 300,
        "wires": [
            [
                "205132b8.03fd46"
            ]
        ]
    },
    {
        "id": "54442106.c1494",
        "type": "comment",
        "z": "b19d2de2.d6a79",
        "name": "Task get all",
        "info": "",
        "x": 80,
        "y": 260,
        "wires": []
    },
    {
        "id": "47af8106.938be",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Loop on Details",
        "func": "let redis = context.flow.get('redis');\n\n/*\nredis.info().then((data)=>{\n    msg.payload = data\n    node.send(msg);\n})\n*/\n\ntasks = msg.payload\nmsg.payload = {}\nmsg.payload.tasks = []\n\nfor (var j = 0; j < tasks.length; j++) {\n    task = tasks[j]\n\n    redis.call(\"hget\", \"taskDetails\", task).then((data)=>{\n        taskJSON = JSON.parse(data)\n        msg.payload.tasks.push(taskJSON)\n    })\n}\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 300,
        "wires": [
            [
                "3fcd1591.b8b802",
                "1115cd00.eb3f3b"
            ]
        ]
    },
    {
        "id": "76570b76.c4cedc",
        "type": "inject",
        "z": "b19d2de2.d6a79",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "10",
        "crontab": "",
        "once": false,
        "onceDelay": "60",
        "x": 170,
        "y": 700,
        "wires": [
            [
                "ee55b0d0.6ed7c8"
            ]
        ]
    },
    {
        "id": "abdffb92.9c2e18",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "zrangebyscore",
        "name": "",
        "topic": "tasks",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 590,
        "y": 700,
        "wires": [
            [
                "3bacf2b7.88e33e"
            ]
        ]
    },
    {
        "id": "ee55b0d0.6ed7c8",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Pre-Process",
        "func": "msg.payload = [ \"-inf\", \"\" + new Date().getTime() ]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 700,
        "wires": [
            [
                "abdffb92.9c2e18"
            ]
        ]
    },
    {
        "id": "1b16f5a5.7509fa",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1010,
        "y": 700,
        "wires": []
    },
    {
        "id": "c277c181.780e",
        "type": "comment",
        "z": "b19d2de2.d6a79",
        "name": "CRON @ 10s",
        "info": "",
        "x": 90,
        "y": 660,
        "wires": []
    },
    {
        "id": "550495fc.813d84",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "hset",
        "name": "",
        "topic": "taskDetails",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 840,
        "y": 140,
        "wires": [
            [
                "9a2b4e5.a67fbb"
            ]
        ]
    },
    {
        "id": "5024946e.d65f3c",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "UserData",
        "func": "// park payload\nmsg.inboundPayload = msg.payload\n\n// enhance parked payload\nmsg.inboundPayload.id = msg.uuid\nmsg.inboundPayload.triggerTimeMs = msg.triggerTimeMs\n\n// build storage request\nmsg.payload = [ msg.uuid, JSON.stringify(msg.inboundPayload) ]\nmsg.topic = \"taskDetails\"\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 100,
        "wires": [
            [
                "550495fc.813d84"
            ]
        ]
    },
    {
        "id": "f9dba8e5.51d4e",
        "type": "switch",
        "z": "b19d2de2.d6a79",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "hask",
                "v": "triggerTimeMs",
                "vt": "str"
            },
            {
                "t": "hask",
                "v": "triggerTimeISO",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 330,
        "y": 140,
        "wires": [
            [
                "b8b90175.fca578"
            ],
            [
                "475c54c5.c6ef64"
            ],
            [
                "7f55b086.d83be"
            ]
        ]
    },
    {
        "id": "7f55b086.d83be",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Add triggerTimeMs",
        "func": "msg.triggerTimeMs = new Date().getTime()\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 180,
        "wires": [
            [
                "5024946e.d65f3c"
            ]
        ]
    },
    {
        "id": "1115cd00.eb3f3b",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 990,
        "y": 340,
        "wires": []
    },
    {
        "id": "4bacfc32.e71ae4",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Date",
        "func": "msg.triggerTimeMs = msg.triggerTimeDate.getTime()\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 140,
        "wires": [
            [
                "5024946e.d65f3c"
            ]
        ]
    },
    {
        "id": "b8b90175.fca578",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Asign triggerTimeMs",
        "func": "msg.triggerTimeMs = msg.payload.triggerTimeMs\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 100,
        "wires": [
            [
                "5024946e.d65f3c"
            ]
        ]
    },
    {
        "id": "49fd0459.99431c",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Post-processing",
        "func": "msg.payload = msg.inboundPayload\nmsg.statusCode = 200\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 140,
        "wires": [
            [
                "cc6b12fe.1ad8d8",
                "b4cd0c04.d7381"
            ]
        ]
    },
    {
        "id": "cc6b12fe.1ad8d8",
        "type": "http response",
        "z": "b19d2de2.d6a79",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 140,
        "wires": []
    },
    {
        "id": "2c001db0.91010a",
        "type": "redis-instance",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "name": "",
        "topic": "redis",
        "location": "flow",
        "block": false,
        "x": 330,
        "y": 260,
        "wires": []
    },
    {
        "id": "ddfe2dc9.4f4548",
        "type": "comment",
        "z": "b19d2de2.d6a79",
        "name": "Task delete all",
        "info": "",
        "x": 90,
        "y": 380,
        "wires": []
    },
    {
        "id": "5ae5715d.4353b",
        "type": "http in",
        "z": "b19d2de2.d6a79",
        "name": "",
        "url": "/tasks",
        "method": "delete",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 420,
        "wires": [
            [
                "6111605c.6f0388"
            ]
        ]
    },
    {
        "id": "6111605c.6f0388",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Pre-Process",
        "func": "msg.payload = [ \"-inf\", \"+inf\" ]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 420,
        "wires": [
            [
                "d20a0e28.3647d"
            ]
        ]
    },
    {
        "id": "a65028ae.5278a8",
        "type": "http response",
        "z": "b19d2de2.d6a79",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 990,
        "y": 420,
        "wires": []
    },
    {
        "id": "d0f0e812.a738e",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Loop on Details",
        "func": "let redis = context.flow.get('redis');\n\n/*\nredis.info().then((data)=>{\n    msg.payload = data\n    node.send(msg);\n})\n*/\n\ntasks = msg.payload\nmsg.payload = {}\nmsg.payload.tasks = []\n\nfor (var j = 0; j < tasks.length; j++) {\n    task = tasks[j]\n\n    redis.call(\"hdel\", \"taskDetails\", task).then((data)=>{\n        \n    })\n}\n\nredis.call(\"del\", \"tasks\").then((data)=>{\n    \n})\n\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 420,
        "wires": [
            [
                "a65028ae.5278a8",
                "f19ff70e.93959"
            ]
        ]
    },
    {
        "id": "f19ff70e.93959",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 990,
        "y": 460,
        "wires": []
    },
    {
        "id": "28df79c8.11abd6",
        "type": "comment",
        "z": "b19d2de2.d6a79",
        "name": "Task delete one",
        "info": "",
        "x": 100,
        "y": 520,
        "wires": []
    },
    {
        "id": "ad1a05e1.2e8e7",
        "type": "http in",
        "z": "b19d2de2.d6a79",
        "name": "",
        "url": "/tasks/:id",
        "method": "delete",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 560,
        "wires": [
            [
                "e0ad37f9.5ff77"
            ]
        ]
    },
    {
        "id": "e027a9de.daeff",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "TimeIndex",
        "func": "msg.payload = [ msg.id ]\nmsg.topic = \"tasks\"\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 540,
        "wires": [
            [
                "e9c12ce9.39b7a"
            ]
        ]
    },
    {
        "id": "71aab919.9980b",
        "type": "http response",
        "z": "b19d2de2.d6a79",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 560,
        "wires": []
    },
    {
        "id": "68c07cec.52b1b4",
        "type": "debug",
        "z": "b19d2de2.d6a79",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1390,
        "y": 600,
        "wires": []
    },
    {
        "id": "e9319f35.5786b8",
        "type": "catch",
        "z": "d6af186b.004918",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 200,
        "y": 960,
        "wires": [
            [
                "fa07d08a.86bc48"
            ]
        ]
    },
    {
        "id": "fa07d08a.86bc48",
        "type": "debug",
        "z": "d6af186b.004918",
        "name": "error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 870,
        "y": 960,
        "wires": []
    },
    {
        "id": "995641a4.2c20e8",
        "type": "redis-in",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "subscribe",
        "name": "queueExecute",
        "topic": "queueExecute",
        "timeout": 0,
        "x": 190,
        "y": 760,
        "wires": [
            [
                "7fd44d84.4c95bc"
            ]
        ]
    },
    {
        "id": "e9c12ce9.39b7a",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "zrem",
        "name": "",
        "topic": "tasks",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 560,
        "y": 580,
        "wires": [
            [
                "f6bff892.cda778"
            ]
        ]
    },
    {
        "id": "43ddd81a.7b55b",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "hdel",
        "name": "",
        "topic": "tasksDetails",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 800,
        "y": 580,
        "wires": [
            [
                "3bfa78ae.33472"
            ]
        ]
    },
    {
        "id": "d20a0e28.3647d",
        "type": "redis-command",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "zrangebyscore",
        "name": "",
        "topic": "tasks",
        "params": "[]",
        "paramsType": "json",
        "payloadType": "json",
        "block": false,
        "x": 570,
        "y": 420,
        "wires": [
            [
                "d0f0e812.a738e"
            ]
        ]
    },
    {
        "id": "f6bff892.cda778",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "UserData",
        "func": "msg.payload = [ msg.id ]\nmsg.topic = \"tasksDetails\"\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 700,
        "y": 540,
        "wires": [
            [
                "43ddd81a.7b55b"
            ]
        ]
    },
    {
        "id": "9cf76a83.57d058",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Post-processing",
        "func": "msg.payload = {}\nmsg.statusCode = 200\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1220,
        "y": 560,
        "wires": [
            [
                "71aab919.9980b",
                "68c07cec.52b1b4"
            ]
        ]
    },
    {
        "id": "3bacf2b7.88e33e",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "Post-processing",
        "func": "let redis = context.flow.get('redis');\n\n/*\nredis.info().then((data)=>{\n    msg.payload = data\n    node.send(msg);\n})\n*/\n\ntasks = msg.payload\nfor (var j = 0; j < tasks.length; j++) {\n    task = tasks[j]\n\n    redis.call(\"hget\", \"taskDetails\", task).then((data)=>{\n        taskJSON = JSON.parse(data)\n        node.send( { payload: taskJSON } );\n    })\n}\n\nreturn null",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 700,
        "wires": [
            [
                "1b16f5a5.7509fa",
                "a0f02889.08df2",
                "5065644.5fa671c"
            ]
        ]
    },
    {
        "id": "a0f02889.08df2",
        "type": "redis-out",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "publish",
        "name": "",
        "topic": "queueExecute",
        "x": 1040,
        "y": 740,
        "wires": []
    },
    {
        "id": "760dbf4b.707fa",
        "type": "telegram receiver",
        "z": "d6af186b.004918",
        "name": "Ghostgbot",
        "bot": "28c31e1f.031b7a",
        "saveDataDir": "/tmp",
        "x": 200,
        "y": 580,
        "wires": [
            [
                "26584add.21e286",
                "2669675d.d9ce08"
            ],
            [
                "1b1ab33f.e9b9ad"
            ]
        ]
    },
    {
        "id": "26584add.21e286",
        "type": "debug",
        "z": "d6af186b.004918",
        "name": "std",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 390,
        "y": 600,
        "wires": []
    },
    {
        "id": "69aa5ab8.7423bc",
        "type": "redis-in",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "subscribe",
        "name": "queueDelete",
        "topic": "queueDelete",
        "timeout": 0,
        "x": 170,
        "y": 600,
        "wires": [
            [
                "8b0ace59.bb08d"
            ]
        ]
    },
    {
        "id": "e0ad37f9.5ff77",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "",
        "func": "msg.id = msg.req.params.id\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 560,
        "wires": [
            [
                "e027a9de.daeff"
            ]
        ]
    },
    {
        "id": "49072487.d36ddc",
        "type": "websocket in",
        "z": "d6af186b.004918",
        "name": "",
        "server": "ad6fda06.930828",
        "client": "",
        "x": 170,
        "y": 500,
        "wires": [
            [
                "6e9628a7.c325a"
            ]
        ]
    },
    {
        "id": "c6840aac.028098",
        "type": "http in",
        "z": "d6af186b.004918",
        "name": "",
        "url": "/agent/chat",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 120,
        "wires": [
            [
                "283ce9f2.9ca366"
            ]
        ]
    },
    {
        "id": "bf8ac2f1.ef05e8",
        "type": "http response",
        "z": "d6af186b.004918",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1070,
        "y": 120,
        "wires": []
    },
    {
        "id": "283ce9f2.9ca366",
        "type": "template",
        "z": "d6af186b.004918",
        "name": "chat html",
        "field": "payload",
        "fieldType": "msg",
        "format": "text",
        "syntax": "mustache",
        "template": "<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>FRED-powered chat app</title>\n  <script src=\"http://code.jquery.com/jquery-1.11.3.min.js\"></script>\n  <script src=\"http:///code.jquery.com/jquery-migrate-1.2.1.min.js\"></script>\n  <style>\n    #messages {border-color:#999; border-style:solid; width:250px; min-height:200px; margin:5px;}\n    .msg {color:#FFF; background-color:#2980B9; padding:2px; margin:2px;}\n    .server {color:#999; background-color:white; font-size:small;}\n    .sentiment-3 {background-color:#992222;}  \n    .sentiment0 {background-color:#2980B9;}\n    .sentiment3 {background-color:#229922;}\n    #form {margin:5px;}\n    #form input {width:250px;}\n  </style>\n</head>\n<body>\n  <div id=\"messages\"></div>\n  <form id=\"form\" onsubmit=\"return false;\">\n    <input id=\"text\" type=\"text\" onkeypress=\"return sendText(event)\" />\n  </form>\n\n  <script type=\"text/javascript\">\n\n    // Open a websocket using FRED.\n    var publishSocket = new WebSocket(\"ws://localhost:3880/agent/receive\");\n    var listenSocket = new WebSocket(\"ws://localhost:3880/agent/publish\");\n\n    listenSocket.onmessage = function (event) {\n      // When receiving a message append a div child to #messages\n      data = JSON.parse(event.data);\n      $(\"#messages\").append(\"<div class='msg sentiment\"+data.sentiment+\"' >\"+data.timestamp+\" - \"+data.msg+\"</div>\")\n      if ($(\"#messages\").children().length > 10 ) { $(\"#messages :first-child\").remove()}\n    }\n\n    listenSocket.onclose = function(event){\n      $(\"#messages\").append(\"<div class='msg server'>Disconnected from server.</div>\");\n    }\n\n    listenSocket.onopen = function(event){\n      $(\"#messages\").append(\"<div class='msg server'>Connected to server.</div>\")\n    }\n\n    function sendText(event) {\n      // Only if return key pressed\n      if (event.keyCode == 13) {\n        // Construct object containing the data the server needs.\n        d = new Date();\n        var data = {\n          msg: $(\"#text\").val(),\n          timestamp: d.getHours() +\":\"+ d.getMinutes() + \":\" + d.getSeconds()\n        };\n        // Send the msg object as a JSON-formatted string.\n        publishSocket.send(JSON.stringify(data));  \n        // Blank the text input element\n        $(\"#text\").val(\"\");\n      }\n    }\n </script>\n\n</body>\n</html>\n",
        "x": 600,
        "y": 120,
        "wires": [
            [
                "bf8ac2f1.ef05e8"
            ]
        ]
    },
    {
        "id": "6e9628a7.c325a",
        "type": "json",
        "z": "d6af186b.004918",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 350,
        "y": 500,
        "wires": [
            [
                "320cc422.94a28c"
            ]
        ]
    },
    {
        "id": "320cc422.94a28c",
        "type": "function",
        "z": "d6af186b.004918",
        "name": "format message",
        "func": "return [ \n    {\n        payload: {\n            \"chatId\":  global.get('telegramID'),\n            \"type\": \"message\",\n            \"options\": { \"parse_mode\": \"Markdown\" },\n            \"content\": \"Agent: \" + msg.payload.msg\n        }\n    },\n    {\n        payload: {\n            msg:msg.payload.msg,\n            timestamp:msg.payload.timestamp\n        }\n    }\n]",
        "outputs": 2,
        "noerr": 0,
        "x": 780,
        "y": 500,
        "wires": [
            [
                "97f98ca8.68217"
            ],
            [
                "686f3fcb.5bb7"
            ]
        ]
    },
    {
        "id": "48957651.fe8ee8",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Serve Agent Chat Room Page",
        "info": "",
        "x": 140,
        "y": 80,
        "wires": []
    },
    {
        "id": "6625e861.2ba06",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Listen & Broadcast events",
        "info": "",
        "x": 130,
        "y": 460,
        "wires": []
    },
    {
        "id": "7fd44d84.4c95bc",
        "type": "change",
        "z": "d6af186b.004918",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "telegramID",
                "pt": "global",
                "to": "payload.telegramID",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 760,
        "wires": [
            [
                "27bd0690.bbba72"
            ]
        ]
    },
    {
        "id": "2669675d.d9ce08",
        "type": "function",
        "z": "d6af186b.004918",
        "name": "format message",
        "func": "return {\n    payload: {\n        msg: msg.originalMessage.from.username + \": \" + msg.payload.content,\n        timestamp: msg.originalMessage.date\n    }\n};",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 540,
        "wires": [
            [
                "686f3fcb.5bb7"
            ]
        ]
    },
    {
        "id": "6aff6f4f.cdbb2",
        "type": "redis-in",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "subscribe",
        "name": "queueTelegramOut",
        "topic": "queueTelegramOut",
        "timeout": 0,
        "x": 170,
        "y": 260,
        "wires": [
            [
                "1b68e80a.d0694"
            ]
        ]
    },
    {
        "id": "104c246f.aa99f4",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Send Telegram Message to User",
        "info": "{\n    payload: {\n        \"chatId\":  <telegramID>,\n        \"type\": \"message\",\n        \"options\": { \"parse_mode\": \"Markdown\" },\n        \"content\": <message>\n    }\n}",
        "x": 150,
        "y": 220,
        "wires": []
    },
    {
        "id": "1b68e80a.d0694",
        "type": "telegram sender",
        "z": "d6af186b.004918",
        "name": "Ghostgbot",
        "bot": "28c31e1f.031b7a",
        "x": 600,
        "y": 260,
        "wires": [
            [
                "254ae785.601568"
            ]
        ]
    },
    {
        "id": "254ae785.601568",
        "type": "debug",
        "z": "d6af186b.004918",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1070,
        "y": 260,
        "wires": []
    },
    {
        "id": "b9596bf4.d93a8",
        "type": "redis-in",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "subscribe",
        "name": "queueWebOut",
        "topic": "queueWebOut",
        "timeout": 0,
        "x": 190,
        "y": 380,
        "wires": [
            [
                "c3ab63b3.b46b4"
            ]
        ]
    },
    {
        "id": "c3ab63b3.b46b4",
        "type": "sentiment",
        "z": "d6af186b.004918",
        "name": "",
        "property": "payload.msg",
        "x": 480,
        "y": 380,
        "wires": [
            [
                "de688237.ee0e5"
            ]
        ]
    },
    {
        "id": "58c5c61f.ecd4d8",
        "type": "websocket out",
        "z": "d6af186b.004918",
        "name": "",
        "server": "f3eba521.b2e75",
        "client": "",
        "x": 1110,
        "y": 380,
        "wires": []
    },
    {
        "id": "346350c7.0dae3",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Send WS Message to Agent",
        "info": "{\n    payload: {\n        msg: <message>,\n        timestamp: <timestamp>\n    }\n}",
        "x": 140,
        "y": 340,
        "wires": []
    },
    {
        "id": "de688237.ee0e5",
        "type": "function",
        "z": "d6af186b.004918",
        "name": "format message",
        "func": "return {\n    payload: {\n        msg: msg.payload.msg,\n        timestamp: msg.payload.timestamp,\n        sentiment: msg.sentiment.score\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 780,
        "y": 380,
        "wires": [
            [
                "58c5c61f.ecd4d8"
            ]
        ]
    },
    {
        "id": "97f98ca8.68217",
        "type": "redis-out",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "publish",
        "name": "",
        "topic": "queueTelegramOut",
        "x": 1110,
        "y": 580,
        "wires": []
    },
    {
        "id": "6665c8db.1d1218",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Open initial Chat",
        "info": "",
        "x": 100,
        "y": 720,
        "wires": []
    },
    {
        "id": "5065644.5fa671c",
        "type": "redis-out",
        "z": "b19d2de2.d6a79",
        "server": "5ed67383.5985ac",
        "command": "publish",
        "name": "",
        "topic": "queueDelete",
        "x": 1030,
        "y": 780,
        "wires": []
    },
    {
        "id": "8b0ace59.bb08d",
        "type": "function",
        "z": "b19d2de2.d6a79",
        "name": "",
        "func": "msg.id = msg.payload.id\nreturn msg",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 600,
        "wires": [
            [
                "e027a9de.daeff"
            ]
        ]
    },
    {
        "id": "3bfa78ae.33472",
        "type": "switch",
        "z": "b19d2de2.d6a79",
        "name": "",
        "property": "req",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "eq",
                "v": "",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 990,
        "y": 560,
        "wires": [
            [
                "9cf76a83.57d058"
            ],
            []
        ]
    },
    {
        "id": "951b321b.014c7",
        "type": "function",
        "z": "d6af186b.004918",
        "name": "create log string",
        "func": "var chatId = msg.payload.chatId;\nvar username = msg.originalMessage.from.username;\nmsg.originalMessage.timestamp = new Date();\nvar message = JSON.stringify(msg.originalMessage);\n\nmsg.topic = username + ' ' + chatId;\nmsg.payload = [msg.topic, message];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 440,
        "y": 1000,
        "wires": [
            [
                "81d73a66.9cef9"
            ]
        ]
    },
    {
        "id": "81d73a66.9cef9",
        "type": "file",
        "z": "d6af186b.004918",
        "name": "LogFile",
        "filename": "/var/log/telegram-unauthorized.log",
        "appendNewline": true,
        "createDir": false,
        "overwriteFile": "false",
        "x": 670,
        "y": 1000,
        "wires": [
            [
                "6dd4f2bf.169a4c"
            ]
        ]
    },
    {
        "id": "6dd4f2bf.169a4c",
        "type": "debug",
        "z": "d6af186b.004918",
        "name": "error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 870,
        "y": 1000,
        "wires": []
    },
    {
        "id": "686f3fcb.5bb7",
        "type": "redis-out",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "publish",
        "name": "",
        "topic": "queueWebOut",
        "x": 1100,
        "y": 660,
        "wires": []
    },
    {
        "id": "1b1ab33f.e9b9ad",
        "type": "redis-out",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "publish",
        "name": "",
        "topic": "telegramError",
        "x": 410,
        "y": 640,
        "wires": []
    },
    {
        "id": "4aad9146.753468",
        "type": "redis-in",
        "z": "d6af186b.004918",
        "server": "5ed67383.5985ac",
        "command": "subscribe",
        "name": "telegramError",
        "topic": "telegramError",
        "timeout": 0,
        "x": 190,
        "y": 1000,
        "wires": [
            [
                "951b321b.014c7"
            ]
        ]
    },
    {
        "id": "a26fd5ef.fa8028",
        "type": "comment",
        "z": "d6af186b.004918",
        "name": "Error Handling",
        "info": "",
        "x": 90,
        "y": 920,
        "wires": []
    }
]